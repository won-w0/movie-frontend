<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì›ìš°ì˜ ì˜í™” ë³´ê´€ì†Œ</title>
    <style>
        /* 1. ê¸°ë³¸ í…Œë§ˆ ì„¤ì • (ë‹¤í¬ ëª¨ë“œ ê°ì„±) */
        :root {
            --primary-color: #ff4081; /* í¬ì¸íŠ¸ ì»¬ëŸ¬ */
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #333;
        }

        body { 
            font-family: 'Pretendard', 'Arial', sans-serif; 
            display: flex; 
            margin: 0; 
            background: var(--bg-color); 
            color: var(--text-color);
        }

        /* 2. ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ (ê³ ì •í˜•) */
        #sidebar { 
            width: 220px; 
            background: #000; 
            height: 100vh; 
            padding: 30px 20px; 
            position: fixed; 
            border-right: 1px solid var(--border-color);
        }

        #sidebar h2 { color: var(--primary-color); text-align: center; margin-bottom: 30px; }

        /* 3. ì½˜í…ì¸  ì˜ì—­ (ì˜í™” ëª©ë¡ ê·¸ë¦¬ë“œ) */
        #content { margin-left: 260px; padding: 40px; flex: 1; }

        /* 4. ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼) */
        button { 
            display: block; 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 12px; 
            cursor: pointer; 
            border: 1px solid var(--border-color); 
            background: transparent; 
            color: #bbb; 
            border-radius: 8px; 
            transition: all 0.3s ease;
            font-weight: bold;
        }

        button:hover { 
            background: var(--primary-color); 
            color: white; 
            border-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(255, 64, 129, 0.4);
        }

        /* 5. ì˜í™” ì¹´ë“œ ìŠ¤íƒ€ì¼ (ê·¸ë¦¬ë“œ ë°°ì¹˜) */
        #movie-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }

        .movie-card { 
            background: var(--card-bg); 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border: 1px solid #222;
        }

        .movie-card h3 { color: var(--primary-color); margin-top: 0; }

        /* 6. ëŒ“ê¸€ ë° ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€) */
        .comment-box { 
            margin-top: 20px; 
            padding-top: 15px; 
            border-top: 1px solid #333; 
        }
    
        .comment-inputs { display: flex; gap: 8px; margin-bottom: 15px; }
    
        input, select, textarea {
            background: #2a2a2a;
            border: 1px solid #444;
            color: white;
            padding: 10px;
            border-radius: 6px;
        }

        .btn-comment { 
            background: var(--primary-color); 
            color: white;
            width: 80px; 
            margin: 0; 
            font-size: 14px; 
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>ì¥ë¥´ ì„ íƒ</h2>
        <button onclick="fetchMovies('Animation')">ì• ë‹ˆë©”ì´ì…˜</button>
        <button onclick="fetchMovies('Action')">ì•¡ì…˜</button>
        <button onclick="fetchMovies('Romance')">ë¡œë§¨ìŠ¤</button>
        <button onclick="fetchMovies('Sci-Fi')">SF</button>
        <button onclick="fetchMovies('Thriller')">ìŠ¤ë¦´ëŸ¬</button>
        <button onclick="fetchMovies('Fantasy')">íŒíƒ€ì§€</button>
    </div>
    <div id="content">
        <h1>ğŸ¬ ì˜í™” ëª©ë¡</h1>
        <div id="movie-list">ì¢Œì¸¡ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì˜í™”ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”!</div>
    </div>

    <div class="movie-card" style="border: 2px solid #ff4081;">
        <h2>ğŸ¬ ìƒˆ ì˜í™” ë“±ë¡</h2>
        <div style="display: grid; gap: 10px;">
            <input type="text" id="new-title" placeholder="ì˜í™” ì œëª©">
            <select id="new-genre">
                <option value="Animation">ì• ë‹ˆë©”ì´ì…˜</option>
                <option value="Action">ì•¡ì…˜</option>
                <option value="Romance">ë¡œë§¨ìŠ¤</option>
                <option value="Sci-Fi">SF</option>
                <option value="Thriller">ìŠ¤ë¦´ëŸ¬</option>
                <option value="Fantasy">íŒíƒ€ì§€</option>
            </select>
            <input type="text" id="new-director" placeholder="ê°ë… ì´ë¦„">
            <input type="number" id="new-rating" step="0.1" placeholder="ì´ˆê¸° ë³„ì  (0~10)">
            <textarea id="new-summary" placeholder="í•œì¤„í‰ì„ ì‘ì„±í•˜ì„¸ìš”..." style="padding: 10px;"></textarea>
            <button style="background: #ff4081; color: white;" onclick="registerMovie()">ì˜í™” ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>

    <script>
        function fetchMovies(genre) {
            const listDiv = document.getElementById('movie-list');
            listDiv.innerHTML = 'ë¡œë”© ì¤‘...';

  	    fetch(`/api/movies?genre=${genre}`)
                .then(response => response.json())
                .then(data => {
                    listDiv.innerHTML = '';
                    if(data.length === 0) { listDiv.innerHTML = 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'; return; }
            
                    data.forEach(movie => {
                        // ê° ì˜í™”ì˜ ëŒ“ê¸€ì„ ê°€ì ¸ì˜¤ëŠ” ì¶”ê°€ ë§ˆë²•!
                        fetch(`/api/comments?movieId=${movie.id}`)
                            .then(res => res.json())
                   	    .then(comments => {
                                // í‰ê·  í‰ì  ê³„ì‚° ë¡œì§: Average = (sum of ratings) / count
                                let avgRating = 0;
                                if (comments.length > 0) {
                                    const sum = comments.reduce((acc, c) => acc + c.rating, 0);
                                    avgRating = (sum / comments.length).toFixed(1);
                                } else {
                                    avgRating = movie.rating; // ëŒ“ê¸€ ì—†ìœ¼ë©´ ê¸°ë³¸ í‰ì  í‘œì‹œ
                                }

                                const card = `
                                    <div class="movie-card">
                                        <h3>${movie.title} (â­í‰ê· : ${avgRating})</h3>
                                        <p><b>ì¥ë¥´:</b> ${movie.genre} | <b>ê°ë…:</b> ${movie.director}</p>
                                        <p>${movie.summary}</p>
                                
                                        <div id="comments-list-${movie.id}" style="background: #f9f9f9; padding: 10px; margin-top: 10px; border-radius: 5px; font-size: 0.9em;">
                                            <strong>ğŸ’¬ ëŒ“ê¸€ (${comments.length}ê°œ)</strong>
                                            ${comments.map(c => `<div><b>${c.userName}:</b> ${c.content} (â­${c.rating})</div>`).join('')}
                                        </div>

                                        <div class="comment-box">
                                            <div class="comment-inputs">
                                                <input type="text" id="user-${movie.id}" placeholder="ë‹‰ë„¤ì„" style="width: 80px;">
                                        	<input type="text" id="content-${movie.id}" placeholder="ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!" style="flex: 1;">
                                        	<input type="number" id="rating-${movie.id}" step="0.1" min="0" max="10" placeholder="í‰ì " style="width: 60px;">
                                        	<button class="btn-comment" onclick="submitComment(${movie.id})">ë“±ë¡</button>
                                    	    </div>
                                	</div>
                            	    </div>`;
                                listDiv.innerHTML += card;
                            });
                    });
                });
        }
            


        function submitComment(movieId) {
            const userName = document.getElementById(`user-${movieId}`).value;
            const content = document.getElementById(`content-${movieId}`).value;
            const rating = document.getElementById(`rating-${movieId}`).value;

            if (!userName || !content) {
                alert("ë‹‰ë„¤ì„ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì¤˜!");
                return;
            }

            fetch('/api/comments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    movieId: movieId,
                    userName: userName,
                    content: content,
                    rating: parseFloat(rating) || 0
                })
            })
            .then(response => response.text())
            .then(msg => {
                alert(msg);
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById(`user-${movieId}`).value = '';
                document.getElementById(`content-${movieId}`).value = '';
                document.getElementById(`rating-${movieId}`).value = '';
            })
            .catch(err => alert('ì „ì†¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err));
        }

        function registerMovie() {
        const movieData = {
            title: document.getElementById('new-title').value,
            genre: document.getElementById('new-genre').value,
            director: document.getElementById('new-director').value,
            rating: parseFloat(document.getElementById('new-rating').value) || 0,
            summary: document.getElementById('new-summary').value
        };

        if (!movieData.title || !movieData.director) {
            alert("ì œëª©ê³¼ ê°ë…ì€ í•„ìˆ˜!");
            return;
        }

        fetch('/api/movies', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(movieData)
        })
        .then(response => response.text())
        .then(msg => {
            alert(msg);
            location.reload(); // ë“±ë¡ í›„ ëª©ë¡ ê°±ì‹ !
        })
        .catch(err => alert('ë“±ë¡ ì‹¤íŒ¨: ' + err));
    }
    </script>
</body>
</html>
